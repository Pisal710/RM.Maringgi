<!DOCTYPE html>
<html lang="id" data-user-id="{{ session.get('user_id', '') }}" data-username="{{ session.get('username', '') }}" data-role="{{ session.get('role', '') }}">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menu RM Maranggi! - Menu Makanan</title>
    <link rel="stylesheet" href="/static/menu.css" />
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">RM Maringgi</div>
        <ul>
            <li><a href="{{ url_for('home_page') }}">Home</a></li>
            <li><a href="{{ url_for('menu_page') }}">Menu</a></li>
            {% if session.username %}
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            {% else %}
                <li><a href="{{ url_for('login_page') }}">Login</a></li>
            {% endif %}
        </ul>
    </nav>

    <div id="pilihMetode"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center;">
        <div
            style="background:linear-gradient(135deg, #8B0000 0%, #a94f4f 100%); color:white; padding:40px 30px; border-radius:10px; width:90%; max-width:380px; text-align:center;">
            <h2 style="margin-bottom:30px; color:#f5f5f5; font-size:1.8em;">Pilih Cara Ambil</h2>

            <button id="btnDelivery"
                style="width:100%; padding:18px; margin:12px 0; background:#ffffff; color:#8B0000; border:none; border-radius:12px; font-size:1.2em; font-weight:bold; cursor:pointer; transition:0.3s;">
                üöö Antar ke Tempat
            </button>

            <button id="btnTakeaway"
                style="width:100%; padding:18px; margin:12px 0; background:#ffffff; color:#8B0000; border:none; border-radius:12px; font-size:1.2em; font-weight:bold; cursor:pointer; transition:0.3s;">
                üè™ Ambil Sendiri
            </button>
        </div>
    </div>

    <!-- FORM ANTAR (hanya muncul kalau pilih delivery) -->
    <div id="formDelivery"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center;">
        <div style="background:linear-gradient(135deg, #8B0000 0%, #a94f4f 100%); padding:30px; border-radius:10px; width:90%; max-width:400px; color:white;">
            <h2 style="text-align:center; margin-bottom:20px; color:#e7e7e7;">üìç Antar ke Tempat</h2>
            <input type="text" id="nama" placeholder="Nama Lengkap"
                style="width:100%; padding:14px; margin:10px 0; border:none; border-radius:10px;">
            <input type="text" id="hp" placeholder="No. HP / WA"
                style="width:100%; padding:14px; margin:10px 0; border:none; border-radius:10px;">
            <div style="position:relative;">
                <textarea id="alamat" placeholder="Alamat lengkap + patokan (contoh: Kompleks Marinda Blok B2 No.10)"
                    style="width:100%; height:90px; padding:14px; margin:10px 0; border:none; border-radius:10px;"></textarea>
                <button id="getLocationBtn"
                    style="position:absolute; bottom:10px; right:10px; padding:5px 10px; background:#4CAF50; color:white; border:none; border-radius:5px; font-size:0.9em; z-index:1000;">Gunakan Lokasi Saat Ini</button>
            </div>
            <div id="locationStatus" style="font-size:0.9em; margin:5px 0; color:#ffeb3b;"></div>
            <div style="text-align:right; margin-top:15px;">
                <button id="btnBatalDelivery"
                    style="padding:12px 20px; background:#FFD700; color:#8B0000; border:none; border-radius:10px; margin-right:10px; font-weight:bold; cursor:pointer;">Batal</button>
                <button id="btnKirimDelivery"
                    style="padding:12px 28px; background:#FFD700; color:#8B0000; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‚úì Kirim Pesanan</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Menu RM Maranggi</h1>
            <p>Pilih menu makanan favorita dan nikmati hidangan lezatnya!</p>
            {% if session.username %}
            <div class="user-info">
                <p>Selamat datang, <strong>{{ session.username }}</strong>! | <a href="{{ url_for('logout') }}">Logout</a></p>
            </div>
            <script>
              // Store session ke sessionStorage untuk dipakai JavaScript client-side
              sessionStorage.setItem('user_id', '{{ session.user_id }}');
              sessionStorage.setItem('username', '{{ session.username }}');
              sessionStorage.setItem('role', '{{ session.role }}');
              
              // RESTORE CART & DELIVERY FORM SETELAH LOGIN
              // Cek apakah ada keranjang yang disimpan di localStorage (dari redirect before login)
              const savedCart = localStorage.getItem('cartItems');
              const savedDeliveryInfo = localStorage.getItem('deliveryInfo');
              const savedSelectedMethod = localStorage.getItem('selectedMethod');
              
              if (savedCart) {
                // Tandai bahwa user baru login dan perlu restore data
                sessionStorage.setItem('needsRestore', 'true');
                console.log('Cart data ditemukan untuk direstore setelah login');
              }
            </script>
            {% endif %}
        </header>

        <!-- menunya -->
        <div class="menu" id="menuMakanan">
            <!-- itemnya ada diJS -->
        </div>

        <!-- keranjang totalnya -->
        <div class="keranjang">
            <h2>Keranjang Belanja</h2>
            <div id="listKeranjang">Isiki keranjangnya jangki liat" saja</div>
            <div id="subtotal">Subtotal: Rp 0</div>
            <button id="checkoutBtn">Pesan</button>
        </div>
    </div>

    <!-- Memuat file-file JavaScript terpisah -->
    <script src="/static/session-init.js"></script>
    <script src="/static/menu_functions.js"></script>
    <script src="/static/cart_functions.js"></script>
    <script src="/static/delivery_functions.js"></script>
    <script src="/static/receipt_functions.js"></script>
    <script src="/static/payment_function.js"></script>
    <script src="/static/menu_app.js"></script>
</body>
</html>
